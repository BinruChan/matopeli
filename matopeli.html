<!DOCTYPE html>
<html>

<head>
    <title></title>
    <style>
        html,
        body {
            height: 100%;
            margin: 10px;
        }

        body {
            background: black;
            /*display: flex;*/
            align-items: center;
            justify-content: center;
            color: aliceblue;
        }

        canvas {
            border: 1px solid white;
            display: block;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            width: 75px;
            height: 75px;


        }

        #menu {
            display: block;
        }

        .hidden {
            display: none!important;
        }

        #up,
        #down {
            width: 50px;
            padding: 5px;
            margin: 5px;
        }

        #left,
        #right {
            width: 20px;
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div id="menu">
        <h2>Viimeisin tulos</h2>
        <h2 id="last-result"></h2>
        <button id="start">Aloita</button>
        <button id="stop">Lopeta</button>
    </div>
    <canvas width="400" height="400" id="game"></canvas>
    <!--
    <div id="controls">
        <button id="up">^</button>
        <button id="left">
            <</button>
                <button id="right">></button>
                <button id="down">v</button>
    </div>
    -->
    <h2>Score</h2>
    <h2 id="score">0</h2>
    <script>
        document.addEventListener("DOMContentLoaded", function (event) {
            var canvas = document.getElementById('game');
            var context = canvas.getContext('2d');
            let score = document.querySelector("#score");
            const menu = document.querySelector("#menu");
            const start = document.querySelector("#start");
            const stop = document.querySelector("#stop");
            let lastResult = document.querySelector("#last-result");
            canvas.classList.add("hidden");
            start.addEventListener('click', function (e) {
                canvas.classList.remove("hidden");

            });
            stop.addEventListener('click', function (e) {
                
                resetGame();
                score.textContent = "0";
                
            });

            var grid = 16;
            var snake = {
                x: 160,
                y: 160,
                dx: grid,
                dy: 0,
                cells: [],
                maxCells: 4
            };
            var count = 0;
            var apple = {
                x: 320,
                y: 320
            };
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }
            // game loop
            function loop() {
                requestAnimationFrame(loop);
                // slow game loop to 15 fps instead of 60 - 60/15 = 4
                if (++count < 4) {
                    return;
                }
                count = 0;
                context.clearRect(0, 0, canvas.width, canvas.height);
                snake.x += snake.dx;
                snake.y += snake.dy;
                // wrap snake position on edge of screen
                if (snake.x < 0) {
                    snake.x = canvas.width - grid;
                }
                else if (snake.x >= canvas.width) {
                    snake.x = 0;
                }
                if (snake.y < 0) {
                    snake.y = canvas.height - grid;
                }
                else if (snake.y >= canvas.height) {
                    snake.y = 0;
                }
                // keep track of where snake has been. front of the array is always the head
                snake.cells.unshift({ x: snake.x, y: snake.y });
                // remove cells as we move away from them
                if (snake.cells.length > snake.maxCells) {
                    snake.cells.pop();
                }
                // draw apple
                context.fillStyle = 'red';
                context.fillRect(apple.x, apple.y, grid - 1, grid - 1);
                // draw snake
                context.fillStyle = 'blue';
                snake.cells.forEach(function (cell, index) {
                    context.fillRect(cell.x, cell.y, grid - 1, grid - 1);
                    // snake ate apple
                    if (cell.x === apple.x && cell.y === apple.y) {
                        snake.maxCells++;
                        apple.x = getRandomInt(0, 25) * grid;
                        apple.y = getRandomInt(0, 25) * grid;
                        score.textContent = snake.maxCells;
                    }
                    // check collision with all cells after this one (modified bubble sort)
                    for (var i = index + 1; i < snake.cells.length; i++) {

                        // collision. reset game
                        if (cell.x === snake.cells[i].x && cell.y === snake.cells[i].y) {
                            resetGame();
                        }
                    }
                });
            }
            function resetGame() {
                if(snake.maxCells !=4){
                    lastResult.textContent = snake.maxCells;
                }
                canvas.classList.add("hidden"); 
                snake.x = 160;
                snake.y = 160;
                snake.cells = [];
                snake.maxCells = 4;
                snake.dx = grid;
                snake.dy = 0;
                apple.x = getRandomInt(0, 25) * grid;
                apple.y = getRandomInt(0, 25) * grid;
            }
            document.addEventListener('keydown', function (e) {
                // prevent snake from backtracking on itself
                //left
                e.preventDefault();
                if (e.which === 37 && snake.dx === 0) {
                    snake.dx = -grid;
                    snake.dy = 0;
                }
                //up
                else if (e.which === 38 && snake.dy === 0) {
                    snake.dy = -grid;
                    snake.dx = 0;
                }
                //right
                else if (e.which === 39 && snake.dx === 0) {
                    snake.dx = grid;
                    snake.dy = 0;
                }
                //down
                else if (e.which === 40 && snake.dy === 0) {
                    snake.dy = grid;
                    snake.dx = 0;
                }
            });
            /*
            const up = document.querySelector("#up");
            const down = document.querySelector("#down");
            const left = document.querySelector("#left");
            const right = document.querySelector("#right");
            down.addEventListener('click', function (e) {
                if (snake.dy === 0) {
                    snake.dy = grid;
                    snake.dx = 0;
                }
            });
            //ylÃ¶s
            up.addEventListener('click', function (e) {
                if (snake.dy === 0) {
                    snake.dy = -grid;
                    snake.dx = 0;
                }
            });
            //oikea
            right.addEventListener('click', function (e) {
                if (snake.dx === 0) {
                    snake.dx = grid;
                    snake.dy = 0;
                }
            });
            //vasen
            left.addEventListener('click', function (e) {
                if (snake.dx === 0) {
                    snake.dx = -grid;
                    snake.dy = 0;
                }
            });
    */
            requestAnimationFrame(loop);
        });
    </script>
</body>

</html>